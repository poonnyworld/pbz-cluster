<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phantom Command</title>
    <style>
        /* (CSS ‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î) */
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Noto+Sans:wght@400;700&display=swap');

        :root {
            --primary: #ff3333;
            --success: #4caf50;
            --dark-bg: #0f0f0f;
            --card-bg: rgba(30, 30, 30, 0.85);
            --text-main: #e0e0e0;
        }

        body {
            font-family: 'Noto Sans', sans-serif;
            background: var(--dark-bg);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
        }

        #toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            background: #333;
            color: white;
            padding: 15px 25px;
            border-radius: 4px;
            border-left: 5px solid var(--primary);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            gap: 10px;
            animation: slideIn 0.3s ease-out forwards;
        }

        .toast.success {
            border-left-color: var(--success);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            gap: 30px;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid var(--primary);
            padding-bottom: 20px;
            margin-bottom: 20px;
        }

        h1 {
            font-family: 'Cinzel', serif;
            color: #fff;
            margin: 0;
            font-size: 2.5rem;
        }

        .logout-btn {
            background: transparent;
            border: 1px solid var(--primary);
            color: var(--primary);
            padding: 8px 20px;
            cursor: pointer;
            font-weight: bold;
        }

        .section {
            background: var(--card-bg);
            padding: 25px;
            border-radius: 4px;
            border-left: 4px solid var(--primary);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        td,
        th {
            padding: 10px;
            border-bottom: 1px solid #333;
            text-align: left;
        }

        .badge {
            background: rgba(255, 51, 51, 0.15);
            color: var(--primary);
            border: 1px solid var(--primary);
            padding: 2px 8px;
            border-radius: 4px;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 20px;
        }

        input,
        select,
        textarea {
            padding: 10px;
            width: 100%;
            box-sizing: border-box;
            background: #222;
            border: 1px solid #444;
            color: white;
            margin-bottom: 10px;
        }

        .btn-add {
            background: var(--primary);
            border: none;
            color: white;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            padding: 10px;
        }

        .btn-icon {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.1em;
            color: #aaa;
            transition: 0.2s;
        }

        .btn-icon:hover {
            color: white;
            transform: scale(1.1);
        }

        .status-badge {
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.75em;
            border: 1px solid #555;
            margin-left: 8px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
        }

        .modal-content {
            background: #1a1a1a;
            margin: 5% auto;
            padding: 30px;
            border: 1px solid var(--primary);
            width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }

        .close {
            float: right;
            font-size: 28px;
            cursor: pointer;
        }

        /* Grading Style */
        .grade-btn {
            cursor: pointer;
            opacity: 0.5;
            font-size: 1.2em;
            margin: 0 5px;
        }

        .grade-btn.active {
            opacity: 1;
            transform: scale(1.2);
        }
    </style>
</head>

<body>
    <div id="toast-container"></div>
    <div class="container">
        <header>
            <h1>üó°Ô∏è Phantom Command</h1>
            <div>
                <button class="logout-btn" style="margin-right:10px; border-color:#4caf50; color:#4caf50;"
                    onclick="location.href='/api/download-db'">‚¨áÔ∏è BACKUP DB</button>
                <button class="logout-btn" onclick="logout()">LOGOUT</button>
            </div>
        </header>

        <div class="grid-2">
            <div>
                <div class="section">
                    <h2>‚öôÔ∏è System Config</h2>
                    <div style="display:flex; justify-content:space-between; padding:5px;"><label>Shop
                            (/store)</label><input type="checkbox" id="toggle_shop"
                            onchange="toggleConfig('shop_enabled',this.checked)" style="width:auto;"></div>
                    <div style="display:flex; justify-content:space-between; padding:5px;"><label>Redeem
                            (/redeem)</label><input type="checkbox" id="toggle_redeem"
                            onchange="toggleConfig('redeem_enabled',this.checked)" style="width:auto;"></div>
                </div>
                <div class="section">
                    <h2>üèÜ Warrior Rankings</h2>
                    <div style="height:300px; overflow-y:auto;">
                        <table id="userTable">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Honor</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="userBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="section">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h2>üìö Quiz Sets</h2>
                    <button class="btn-add" style="width:auto;" onclick="openModal('createSetModal')">+ NEW SET</button>
                </div>
                <div id="quizSetsContainer" style="margin-top:20px;"></div>
            </div>
        </div>
    </div>

    <div id="createSetModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('createSetModal')">&times;</span>
            <h3>Create Quiz Set</h3>
            <input type="text" id="newSetTitle" placeholder="Title">
            <input type="text" id="newSetDesc" placeholder="Description">
            <label style="color:#aaa;">Type:</label>
            <select id="newSetType">
                <option value="BINGO" selected>üéØ Bingo Prediction</option>
                <option value="STANDARD">üìù Standard Quiz</option>
            </select>
            <input type="text" id="newSetRoleId" placeholder="Completion Role ID (Optional)">
            <button class="btn-add" onclick="createSet()">CREATE</button>
        </div>
    </div>

    <div id="editSetModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('editSetModal')">&times;</span>
            <h3>Edit Quiz Set</h3>
            <input type="hidden" id="editSetId">
            <label>Title</label><input type="text" id="editSetTitle">
            <label>Description</label><input type="text" id="editSetDesc">
            <label>Completion Role ID</label><input type="text" id="editSetRoleId">
            <button class="btn-add" onclick="saveSet()">SAVE CHANGES</button>
        </div>
    </div>

    <div id="editQModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('editQModal')">&times;</span>
            <h3>Edit Question</h3>
            <input type="hidden" id="editQId">
            <div style="display:flex; gap:10px;">
                <div style="flex:1"><label>Order</label><input type="number" id="editQOrder" placeholder="Order"></div>
                <div style="flex:1"><label>Reward</label><input type="number" id="editQReward" placeholder="Reward">
                </div>
            </div>

            <label>Question Type</label>
            <select id="editQType" onchange="renderAnswerInput()">
                <option value="BOOLEAN">‚úÖ Yes / No</option>
                <option value="CHOICE">üîΩ Dropdown Choice</option>
                <option value="TEXT">üî§ Text Input</option>
            </select>

            <label>Question</label>
            <input type="text" id="editQText">

            <div style="margin: 10px 0; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 4px;">
                <label style="display:inline-flex; align-items:center; cursor:pointer;">
                    <input type="checkbox" id="editQManual" style="width:auto; margin-right:10px;">
                    ‚úã Manual Grading (Admin checks answer)
                </label>
            </div>

            <div id="divOptions" style="display:none;">
                <label>Choices (comma separated, e.g. Jan,Feb,Mar)</label>
                <input type="text" id="editQOptions" onkeyup="renderAnswerInput()">
            </div>

            <label>Correct Answer</label>
            <div id="answerInputContainer"></div>

            <button class="btn-add" onclick="saveQuestion()" style="margin-top:20px;">SAVE QUESTION</button>
        </div>
    </div>

    <div id="monitorModal" class="modal">
        <div class="modal-content" style="width:700px;">
            <span class="close" onclick="closeModal('monitorModal')">&times;</span>
            <h3>üëÅÔ∏è Monitor & Grading</h3>

            <div style="margin-bottom:15px; display:flex; gap:10px; align-items:center;">
                <label>Select User:</label>
                <select id="monitorUserSelect" onchange="renderMonitorTable()" style="flex:1; margin:0;">
                    <option value="">-- Choose User --</option>
                </select>
            </div>

            <div id="monitorContent"
                style="max-height:400px; overflow-y:auto; margin-bottom:20px; border:1px solid #333; padding:10px;">
            </div>

            <button class="btn-add" onclick="saveGrades()" style="background:#4caf50;">‚úÖ CONFIRM & SAVE GRADES</button>
        </div>
    </div>

    <div id="userModal" class="modal">
        <div class="modal-content"><span class="close" onclick="closeModal('userModal')">&times;</span>
            <h3>Edit User</h3><input type="hidden" id="editUserId">
            <p id="editUserName"></p><input type="number" id="editUserSouls"><button class="btn-add"
                onclick="saveUser()">SAVE</button>
        </div>
    </div>

    <script>
        function showToast(m, ok = true) { const c = document.getElementById('toast-container'); const t = document.createElement('div'); t.className = `toast ${ok ? 'success' : 'error'}`; t.innerHTML = `<span>${ok ? '‚úÖ' : '‚ùå'}</span> <span>${m}</span>`; c.appendChild(t); setTimeout(() => { t.remove() }, 3000); }
        function logout() { fetch('/api/logout', { method: 'POST' }).then(() => window.location.href = '/login.html') }
        fetch('/api/check-auth').then(r => r.json()).then(d => { if (!d.loggedIn) window.location.href = '/login.html' });

        let allSets = [];

        // --- USERS ---
        async function fetchUsers() { const r = await fetch('/api/users'); const u = await r.json(); document.getElementById('userBody').innerHTML = u.map(x => `<tr><td>${x.username}</td><td><span class="badge">${x.souls}</span></td><td><button class="btn-icon" onclick="openUserModal('${x.id}','${x.username}',${x.souls})">‚úèÔ∏è</button></td></tr>`).join(''); }
        function openUserModal(id, n, s) { document.getElementById('userModal').style.display = 'block'; document.getElementById('editUserId').value = id; document.getElementById('editUserName').innerText = n; document.getElementById('editUserSouls').value = s; }
        async function saveUser() { await fetch(`/api/users/${document.getElementById('editUserId').value}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ souls: document.getElementById('editUserSouls').value }) }); closeModal('userModal'); fetchUsers(); showToast("Saved"); }

        // --- CONFIG ---
        async function fetchConfig() { const r = await fetch('/api/config'); const c = await r.json(); document.getElementById('toggle_shop').checked = c['shop_enabled']; document.getElementById('toggle_redeem').checked = c['redeem_enabled']; }
        async function toggleConfig(k, v) { await fetch('/api/config', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ key: k, value: v }) }); showToast("Config Saved"); }

        // --- FETCH SETS ---
        async function fetchSets() { const r = await fetch('/api/quiz-sets'); if (r.ok) { allSets = await r.json(); renderSets(); } }

        // ‚úÖ RENDER SETS
        function renderSets() {
            const c = document.getElementById('quizSetsContainer'); c.innerHTML = '';
            allSets.forEach(s => {
                const isBingo = s.type === 'BINGO';
                const qs = s.questions.sort((a, b) => a.order - b.order);

                const qHtml = qs.map(q => {
                    let ansStr = ''; try { ansStr = JSON.parse(q.answers).join(', '); } catch (e) { ansStr = q.answers }
                    const typeBadge = `<span style="font-size:0.7em; background:#333; padding:2px 5px; border-radius:3px; color:#aaa; margin-right:5px; border:1px solid #444;">${q.inputType || 'TEXT'}</span>`;
                    const manualIcon = q.manualGrading ? '‚úã ' : '';

                    return `<div style="background:rgba(0,0,0,0.3);padding:10px;margin:5px 0;display:flex;justify-content:space-between;align-items:center;">
                        <div style="flex:1;">
                            ${typeBadge}
                            <b>#${q.order}</b> ${manualIcon}${q.question}<br>
                            <small style="color:#aaa">Ans: ${ansStr} | ${q.rewardPoints}pts</small>
                        </div>
                        <div>
                            <button class="btn-icon" onclick="openEditQ(${q.id},${s.id})">‚úèÔ∏è</button>
                            ${isBingo ? '' : `<button class="btn-icon" onclick="delQ(${q.id})">üóëÔ∏è</button>`}
                        </div>
                    </div>`;
                }).join('');

                let addHtml = '';
                if (!isBingo) {
                    addHtml = `
                    <div style="padding:10px; text-align:center; border-top:1px dashed #444; margin-top:5px;">
                        <button class="btn-add" style="width:auto; background:transparent; border:1px dashed #666; color:#aaa; padding:5px 15px;" onclick="addQ(${s.id})">
                            + Add New Question
                        </button>
                    </div>`;
                }

                c.innerHTML += `
                <div style="background:rgba(255,255,255,0.05);padding:15px;margin-bottom:15px;border-radius:4px;">
                    <div style="display:flex;justify-content:space-between;border-bottom:1px solid #444;padding-bottom:10px;margin-bottom:10px;">
                        <div>
                            <h3 style="margin:0;display:inline;">${s.title}</h3>
                            <span class="status-badge status-${s.status}">${s.status}</span>
                            <span class="status-badge" style="background:${isBingo ? '#9b59b6' : '#34495e'}">${s.type}</span>
                        </div>
                        <div>
                            <button class="btn-icon" onclick="openMonitor(${s.id})" title="Monitor & Grade">üëÅÔ∏è</button>
                            <button class="btn-icon" onclick="openEditSet(${s.id})">üìù</button>
                            <button class="btn-icon" onclick="delSet(${s.id})">üóëÔ∏è</button>
                        </div>
                    </div>
                    <div style="margin-top:10px;">${qHtml}</div>
                    ${addHtml}
                </div>`;
            });
        }

        // --- ACTIONS ---
        async function addQ(sid) {
            const s = allSets.find(x => x.id === sid);
            const nextOrder = s.questions.length + 1;
            await fetch('/api/quizzes', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    setId: sid,
                    question: "New Question (Click Edit)",
                    answers: "Yes",
                    rewardPoints: 10,
                    order: nextOrder,
                    inputType: 'BOOLEAN'
                })
            });
            fetchSets();
            showToast("Question Added");
        }

        async function createSet() {
            const t = document.getElementById('newSetTitle').value; const d = document.getElementById('newSetDesc').value; const r = document.getElementById('newSetRoleId').value; const type = document.getElementById('newSetType').value;
            const res = await fetch('/api/quiz-sets', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ title: t, description: d, completionRoleId: r, type: type }) });
            if (res.ok) { showToast("Set Created"); closeModal('createSetModal'); fetchSets(); } else showToast("Failed to create", false);
        }
        function openEditSet(id) { const s = allSets.find(x => x.id === id); document.getElementById('editSetId').value = id; document.getElementById('editSetTitle').value = s.title; document.getElementById('editSetDesc').value = s.description; document.getElementById('editSetRoleId').value = s.completionRoleId || ''; openModal('editSetModal'); }
        async function saveSet() { const id = document.getElementById('editSetId').value; await fetch(`/api/quiz-sets/${id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ title: document.getElementById('editSetTitle').value, description: document.getElementById('editSetDesc').value, completionRoleId: document.getElementById('editSetRoleId').value }) }); closeModal('editSetModal'); fetchSets(); showToast("Set Updated"); }
        async function delSet(id) { if (confirm("Delete this set?")) { await fetch(`/api/quiz-sets/${id}`, { method: 'DELETE' }); fetchSets(); showToast("Set Deleted"); } }
        async function delQ(id) { if (confirm("Delete this question?")) { await fetch(`/api/quizzes/${id}`, { method: 'DELETE' }); fetchSets(); showToast("Question Deleted"); } }

        // --- EDIT QUESTION ---
        function openEditQ(qid, sid) {
            const s = allSets.find(x => x.id === sid); const q = s.questions.find(x => x.id === qid);
            document.getElementById('editQId').value = q.id;
            document.getElementById('editQOrder').value = q.order;
            document.getElementById('editQText').value = q.question;
            document.getElementById('editQReward').value = q.rewardPoints;
            document.getElementById('editQManual').checked = q.manualGrading || false;
            document.getElementById('editQType').value = q.inputType || 'TEXT';
            let opts = ''; try { if (q.options) opts = JSON.parse(q.options).join(','); } catch (e) { }
            document.getElementById('editQOptions').value = opts;
            renderAnswerInput();
            let ansVal = q.answers;
            try { const p = JSON.parse(q.answers); if (Array.isArray(p)) ansVal = p[0]; } catch (e) { }
            setTimeout(() => { const input = document.getElementById('dynamicAnsInput'); if (input) input.value = ansVal; }, 50);
            openModal('editQModal');
        }

        function renderAnswerInput() {
            const type = document.getElementById('editQType').value;
            const container = document.getElementById('answerInputContainer');
            const divOptions = document.getElementById('divOptions');
            container.innerHTML = '';

            if (type === 'BOOLEAN') {
                divOptions.style.display = 'none';
                container.innerHTML = `<select id="dynamicAnsInput" style="width:100%;padding:10px;background:#222;border:1px solid #444;color:white;"><option value="Yes">Yes</option><option value="No">No</option></select>`;
            } else if (type === 'CHOICE') {
                divOptions.style.display = 'block';
                const optsText = document.getElementById('editQOptions').value;
                const opts = optsText.split(',').filter(x => x.trim() !== '');
                let html = `<select id="dynamicAnsInput" style="width:100%;padding:10px;background:#222;border:1px solid #444;color:white;">`;
                if (opts.length === 0) html += `<option value="">(Add options above first)</option>`;
                opts.forEach(o => html += `<option value="${o.trim()}">${o.trim()}</option>`);
                html += `</select>`;
                container.innerHTML = html;
            } else {
                divOptions.style.display = 'none';
                container.innerHTML = `<input type="text" id="dynamicAnsInput" placeholder="Correct Answer Text">`;
            }
        }

        async function saveQuestion() {
            const id = document.getElementById('editQId').value;
            const type = document.getElementById('editQType').value;
            const ansVal = document.getElementById('dynamicAnsInput').value;
            let options = null;
            if (type === 'CHOICE') options = JSON.stringify(document.getElementById('editQOptions').value.split(',').filter(x => x));

            const body = {
                order: document.getElementById('editQOrder').value,
                question: document.getElementById('editQText').value,
                answers: ansVal,
                rewardPoints: document.getElementById('editQReward').value,
                inputType: type,
                options: options,
                manualGrading: document.getElementById('editQManual').checked
            };
            await fetch(`/api/quizzes/${id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
            closeModal('editQModal'); fetchSets(); showToast("Question Updated");
        }

        // --- MONITOR ---
        let currentAnswers = [], pendingChanges = {};
        async function openMonitor(setId) {
            const r = await fetch(`/api/monitor/${setId}`); currentAnswers = await r.json(); pendingChanges = {};
            const users = {}; currentAnswers.forEach(a => users[a.userId] = a.user.username);
            const select = document.getElementById('monitorUserSelect'); select.innerHTML = '<option value="">-- Choose User --</option>';
            Object.keys(users).forEach(uid => { select.innerHTML += `<option value="${uid}">${users[uid]}</option>` });
            document.getElementById('monitorContent').innerHTML = '<p style="text-align:center;color:#888;">Please select a user to grade.</p>';
            openModal('monitorModal');
        }
        function renderMonitorTable() {
            const userId = document.getElementById('monitorUserSelect').value; const container = document.getElementById('monitorContent');
            if (!userId) { container.innerHTML = ''; return; }
            const userAns = currentAnswers.filter(a => a.userId == userId);
            let html = '<table style="width:100%;border-collapse:collapse;"><thead><tr style="border-bottom:1px solid #555;"><th>Question</th><th>Answer</th><th style="text-align:center;">Grade</th></tr></thead><tbody>';
            userAns.forEach(a => {
                let isPass = a.isCorrect === true; if (pendingChanges[a.id] !== undefined) isPass = pendingChanges[a.id];
                const passClass = isPass ? 'opacity:1;transform:scale(1.2);color:#4caf50;' : 'opacity:0.3;';
                const failClass = !isPass && (pendingChanges[a.id] !== undefined || a.isCorrect === false) ? 'opacity:1;transform:scale(1.2);color:#f44336;' : 'opacity:0.3;';
                let dbStatus = ''; if (a.isCorrect === null) dbStatus = '<span style="font-size:0.7em;background:#e67e22;padding:2px 4px;border-radius:3px;">WAITING</span>';
                else if (a.isCorrect) dbStatus = '<span style="font-size:0.7em;color:#4caf50;">(Passed)</span>';
                else dbStatus = '<span style="font-size:0.7em;color:#f44336;">(Failed)</span>';
                const manualIcon = a.question.manualGrading ? '‚úã' : '';
                html += `<tr style="border-bottom:1px solid #333;"><td style="padding:10px;"><small style="color:#aaa;">${manualIcon} Q${a.question.order}</small><br>${a.question.question}</td><td style="padding:10px;">${a.answer}<br>${dbStatus}</td><td style="text-align:center;"><button onclick="stageGrade(${a.id},true)" style="background:none;border:none;cursor:pointer;font-size:1.5em;${passClass}">‚úÖ</button><button onclick="stageGrade(${a.id},false)" style="background:none;border:none;cursor:pointer;font-size:1.5em;${failClass}">‚ùå</button></td></tr>`;
            });
            html += '</tbody></table>'; container.innerHTML = html;
        }
        function stageGrade(ansId, isCorrect) { pendingChanges[ansId] = isCorrect; renderMonitorTable(); }
        async function saveGrades() {
            const p = [], ids = Object.keys(pendingChanges); if (ids.length === 0) return showToast("No changes to save", false);
            ids.forEach(id => { p.push(fetch(`/api/grade/${id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ isCorrect: pendingChanges[id] }) })); });
            await Promise.all(p); ids.forEach(id => { const a = currentAnswers.find(x => x.id == id); if (a) a.isCorrect = pendingChanges[id]; });
            pendingChanges = {}; renderMonitorTable(); showToast(`Saved ${ids.length} changes!`);
        }

        function openModal(id) { document.getElementById(id).style.display = 'block' }
        function closeModal(id) { document.getElementById(id).style.display = 'none' }
        window.onclick = function (e) { if (e.target.classList.contains('modal')) e.target.style.display = "none" }

        fetchConfig(); fetchUsers(); fetchSets();
    </script>
</body>

</html>